{"pageProps":{"post":{"slug":"2021-05-09-a-debugging-story","title":"A debugging story","subtitle":"Could this bug for once not be my fault?","image":{"url":"/assets/content/blog/2021-05-09-a-debugging-story/issue_4117.png","alt":"The screenshot showing the issue -- a rendering defect in OctoPrint's GCode viewer","external":"https://foosel.net/assets/content/blog/2021-05-09-a-debugging-story/issue_4117.png"},"content":"\nAbout a week ago I got a new [bug report](https://github.com/OctoPrint/OctoPrint/issues/4117) on [OctoPrint's](https://octoprint.org) issue tracker:\n\n> **GCode Viewer Visualisation Problem**\n>\n> *The problem*\n> \n> The visualisation in GCode viewer ist not correct. The print is OK.\n> See gcode file (zip) on Layer 43 to 47 and 49\n>\n> And screenshot\n\nYou already saw the included screenshot, and it shows that there was a spike being visualized in the GCode Viewer that\nwasn't actually there. My first attempt at reproduction failed spectacularly -- the file looked exactly like\nit was supposed to. Then I noticed that the OP was using Google Chrome however (adding the detected user agent\nto the system information contained in OctoPrint's new System Info Bundles already paid off!) and tried with that\ninstead of my usual Firefox, and lo and behold, I saw the issue.\n\nScrolling a bit through the file revealed further defects, as also mentioned by the OP, e.g. this one:\n\n![Another defect, this time a whole part of the outline is being misplaced](./issue_4117_2.png)\n\nAt this point it was clear that this was a Chrome-only issue. But was it a bug in OctoPrint or possibly a browser \nbug? More information for that was needed but not readily available, and the file was also too big to quickly\ngleam anything from the GCode itself that could possibly help to narrow down on the problem. \n\nSo the first step was to create a minimal GCode file that showed the same error. For this I took a look at \nthe reported layer height in the viewer on the layer a defect was visible and then narrowed down on the affected lines\nby using the horizontal command sliders to further limit the view. That way I quickly found that these were the \nproblematic lines:\n\n``` gcode\nG1 X173.595 Y103.9 E247.16716\nG3 X173.600 Y126.097 I-105613.507 J39.645 E248.20080\nG1 X169.552 Y126.098 E248.38933\n```\n\nMore specifically, the error was caused by the contained [`G3` command](https://reprap.org/wiki/G-code#G2_.26_G3:_Controlled_Arc_Move), \nwhich instructs the printer to move in a counter clockwise arc\nfrom its current position to the given X and Y coordinates, with the center of said arc offset by the given I and J\nparameters. In the case of these lines, that meant to move in an arc from `(173.595, 103.0)` to `(173.600, 126.097)`\nwith the arc's center at `x = 173.595 + (-105613.507) = -105439.912` and `y = 103.9 + 39.645 = 143.54500000000002`. \nOr in other words, a rather short arc with an enormous radius of over 105m that was more a straight line than\nan arc really. And that line was being drawn too long, causing the weird spike in the rendition.\n\nIn order to understand how that could happen however we need to take a look at how the GCode viewer is implemented and how\narcs work in that implementation. At its core, the GCode viewer is an HTML5 2D canvas on which the path described in \na GCode file gets drawn. Commands like `G0` and `G1` that describe straight lines are drawn using [`lineTo`](https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/lineTo),\narcs as described by `G2` and `G3` are drawn using [`arc`](https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/arc).\n\n`arc` takes six parameters: the `x` and `y` coordinate of the center of the arc, the radius `r`, the `startAngle` determining from which angle to start\ndrawing the arc and the `endAngle` until which to draw the arc, and a flag that's `true` for counter clockwise and `false` or empty for clockwise.\nIt is obvious this doesn't directly translate to the data contained in the GCode itself, where we rather have three points defining the arc -- a start\npoint, and end point, and the arc's center. So we need to translate this into the data required by the `arc` method. Using some trigonometry,\nthat is fairly straightforward:\n\n``` js\n// given: G2/G3 X<endX> Y<endY> I<i> J<j>, <startX>, <startY>\narcX = startX + i;\narcY = startY + j;\nr = Math.sqrt(i * i + j * j);\nstartAngle = Math.atan2(startY - arcY, startX - arcX);\nendAngle = Math.atan2(endY - arcY, endX - arcX);\nccw = (command === \"G3\")\n```\n\n![The parameters and their relation](./drawing.png)\n\nMy first guess was that the result of this conversion was somehow different between Firefox and Chrome, and so I modified the GCode viewer to log\nthe calculated values and then compared the two outcomes. The values were completely identical between both browsers, so what was being fed\ninto the canvas `arc` command was identical and yet produces different results. Why?\n\nMy next approach was to add some more visual debug output to the viewer itself. I modified it such that the arc parameters as calculated would \nactually be drawn on the canvas as well, in form of a geometrical pizza slice showing the arc's center, its \"legs\" and its rim. And this is where\nI saw a difference in the rendered output. Where in Firefox the arc's rim and its legs met perfectly:\n\n![The arc in Firefox is rendered correctly](./arc_ff.png)\n\nin Chrome the rim overshot:\n\n![The same arc in Chrome is rendered wrong](./arc_chrome.png)\n\nSo while the calculated parameters were correct and in both cases provided to the `arc` method just the same, Chrome was rendering the wrong segment length! \n\nI suspected a rounding error and thus started searching for matching reports from other people. I couldn't find a specific bug report, but I came across a post on Stack Overflow that sounded mightily familiar: [HTML5 canvas arcs not rendering correctly in Google Chrome](https://stackoverflow.com/questions/8603656/html5-canvas-arcs-not-rendering-correctly-in-google-chrome), from 2011. A ten year old post... could it be?\n\nHonestly, I still do not know if this indeed described the same issue or not, or if there's a Chrome ticket describing this behaviour -- I'll continue to look, but first and foremost I was focused on fixing this problem in OctoPrint's GCode viewer. The Stack Overflow post provided a code snippet that reimplements `arc` utilizing bezier curves, and so I gave this a try. Long story short, OctoPrint's GCode Viewer as part of version 1.7.0+ will ship with a Chrome-only `arc` replacement that will be enabled by default, but can also be disabled in real time, with great effect:\n\n![Enabling and disabling the arc workaround makes the defects disappear and reappear](./arc_fix.gif)\n\nAnd the moral of the story: It rarely is a browser bug. But sometimes, all signs say it indeed *is* and a workaround is the easiest solution.\n","assets":[{"slug":"2021-05-09-a-debugging-story","asset":"arc_chrome.png","path":"/home/runner/work/foosel.github.io/foosel.github.io/content/posts/2021-05-09-a-debugging-story/arc_chrome.png"},{"slug":"2021-05-09-a-debugging-story","asset":"arc_ff.png","path":"/home/runner/work/foosel.github.io/foosel.github.io/content/posts/2021-05-09-a-debugging-story/arc_ff.png"},{"slug":"2021-05-09-a-debugging-story","asset":"arc_fix.gif","path":"/home/runner/work/foosel.github.io/foosel.github.io/content/posts/2021-05-09-a-debugging-story/arc_fix.gif"},{"slug":"2021-05-09-a-debugging-story","asset":"drawing.png","path":"/home/runner/work/foosel.github.io/foosel.github.io/content/posts/2021-05-09-a-debugging-story/drawing.png"},{"slug":"2021-05-09-a-debugging-story","asset":"issue_4117.png","path":"/home/runner/work/foosel.github.io/foosel.github.io/content/posts/2021-05-09-a-debugging-story/issue_4117.png"},{"slug":"2021-05-09-a-debugging-story","asset":"issue_4117_2.png","path":"/home/runner/work/foosel.github.io/foosel.github.io/content/posts/2021-05-09-a-debugging-story/issue_4117_2.png"}],"published":"2021-05-09T00:00:00Z","readingtime":{"text":"6 min read","minutes":5.27,"time":316200,"words":1054},"mdx":{"compiledSource":"\"use strict\";\n\nfunction _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsxRuntime classic */\n\n/* @jsx mdx */\nvar layoutProps = {};\nvar MDXLayout = \"wrapper\";\n\nfunction MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, [\"components\"]);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"p\", null, \"About a week ago I got a new \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://github.com/OctoPrint/OctoPrint/issues/4117\"\n  }, \"bug report\"), \" on \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://octoprint.org\"\n  }, \"OctoPrint's\"), \" issue tracker:\"), mdx(\"blockquote\", null, mdx(\"p\", {\n    parentName: \"blockquote\"\n  }, mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"GCode Viewer Visualisation Problem\")), mdx(\"p\", {\n    parentName: \"blockquote\"\n  }, mdx(\"em\", {\n    parentName: \"p\"\n  }, \"The problem\")), mdx(\"p\", {\n    parentName: \"blockquote\"\n  }, \"The visualisation in GCode viewer ist not correct. The print is OK.\\nSee gcode file (zip) on Layer 43 to 47 and 49\"), mdx(\"p\", {\n    parentName: \"blockquote\"\n  }, \"And screenshot\")), mdx(\"p\", null, \"You already saw the included screenshot, and it shows that there was a spike being visualized in the GCode Viewer that\\nwasn't actually there. My first attempt at reproduction failed spectacularly -- the file looked exactly like\\nit was supposed to. Then I noticed that the OP was using Google Chrome however (adding the detected user agent\\nto the system information contained in OctoPrint's new System Info Bundles already paid off!) and tried with that\\ninstead of my usual Firefox, and lo and behold, I saw the issue.\"), mdx(\"p\", null, \"Scrolling a bit through the file revealed further defects, as also mentioned by the OP, e.g. this one:\"), mdx(\"p\", null, mdx(\"img\", {\n    parentName: \"p\",\n    \"src\": \"./issue_4117_2.png\",\n    \"alt\": \"Another defect, this time a whole part of the outline is being misplaced\"\n  })), mdx(\"p\", null, \"At this point it was clear that this was a Chrome-only issue. But was it a bug in OctoPrint or possibly a browser\\nbug? More information for that was needed but not readily available, and the file was also too big to quickly\\ngleam anything from the GCode itself that could possibly help to narrow down on the problem. \"), mdx(\"p\", null, \"So the first step was to create a minimal GCode file that showed the same error. For this I took a look at\\nthe reported layer height in the viewer on the layer a defect was visible and then narrowed down on the affected lines\\nby using the horizontal command sliders to further limit the view. That way I quickly found that these were the\\nproblematic lines:\"), mdx(\"pre\", {\n    \"className\": \"language-gcode\"\n  }, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-gcode\"\n  }, \"G1 X173.595 Y103.9 E247.16716\\nG3 X173.600 Y126.097 I-105613.507 J39.645 E248.20080\\nG1 X169.552 Y126.098 E248.38933\\n\")), mdx(\"p\", null, \"More specifically, the error was caused by the contained \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://reprap.org/wiki/G-code#G2_.26_G3:_Controlled_Arc_Move\"\n  }, mdx(\"inlineCode\", {\n    parentName: \"a\"\n  }, \"G3\"), \" command\"), \",\\nwhich instructs the printer to move in a counter clockwise arc\\nfrom its current position to the given X and Y coordinates, with the center of said arc offset by the given I and J\\nparameters. In the case of these lines, that meant to move in an arc from \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"(173.595, 103.0)\"), \" to \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"(173.600, 126.097)\"), \"\\nwith the arc's center at \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"x = 173.595 + (-105613.507) = -105439.912\"), \" and \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"y = 103.9 + 39.645 = 143.54500000000002\"), \".\\nOr in other words, a rather short arc with an enormous radius of over 105m that was more a straight line than\\nan arc really. And that line was being drawn too long, causing the weird spike in the rendition.\"), mdx(\"p\", null, \"In order to understand how that could happen however we need to take a look at how the GCode viewer is implemented and how\\narcs work in that implementation. At its core, the GCode viewer is an HTML5 2D canvas on which the path described in\\na GCode file gets drawn. Commands like \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"G0\"), \" and \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"G1\"), \" that describe straight lines are drawn using \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/lineTo\"\n  }, mdx(\"inlineCode\", {\n    parentName: \"a\"\n  }, \"lineTo\")), \",\\narcs as described by \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"G2\"), \" and \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"G3\"), \" are drawn using \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/arc\"\n  }, mdx(\"inlineCode\", {\n    parentName: \"a\"\n  }, \"arc\")), \".\"), mdx(\"p\", null, mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"arc\"), \" takes six parameters: the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"x\"), \" and \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"y\"), \" coordinate of the center of the arc, the radius \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"r\"), \", the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"startAngle\"), \" determining from which angle to start\\ndrawing the arc and the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"endAngle\"), \" until which to draw the arc, and a flag that's \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"true\"), \" for counter clockwise and \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"false\"), \" or empty for clockwise.\\nIt is obvious this doesn't directly translate to the data contained in the GCode itself, where we rather have three points defining the arc -- a start\\npoint, and end point, and the arc's center. So we need to translate this into the data required by the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"arc\"), \" method. Using some trigonometry,\\nthat is fairly straightforward:\"), mdx(\"pre\", {\n    \"className\": \"language-js\"\n  }, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-js\"\n  }, mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token comment\"\n  }, \"// given: G2/G3 X<endX> Y<endY> I<i> J<j>, <startX>, <startY>\"), \"\\narcX \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token operator\"\n  }, \"=\"), \" startX \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token operator\"\n  }, \"+\"), \" i\", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \";\"), \"\\narcY \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token operator\"\n  }, \"=\"), \" startY \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token operator\"\n  }, \"+\"), \" j\", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \";\"), \"\\nr \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token operator\"\n  }, \"=\"), \" Math\", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \".\"), mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token function\"\n  }, \"sqrt\"), mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \"(\"), \"i \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token operator\"\n  }, \"*\"), \" i \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token operator\"\n  }, \"+\"), \" j \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token operator\"\n  }, \"*\"), \" j\", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \")\"), mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \";\"), \"\\nstartAngle \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token operator\"\n  }, \"=\"), \" Math\", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \".\"), mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token function\"\n  }, \"atan2\"), mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \"(\"), \"startY \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token operator\"\n  }, \"-\"), \" arcY\", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \",\"), \" startX \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token operator\"\n  }, \"-\"), \" arcX\", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \")\"), mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \";\"), \"\\nendAngle \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token operator\"\n  }, \"=\"), \" Math\", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \".\"), mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token function\"\n  }, \"atan2\"), mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \"(\"), \"endY \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token operator\"\n  }, \"-\"), \" arcY\", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \",\"), \" endX \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token operator\"\n  }, \"-\"), \" arcX\", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \")\"), mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \";\"), \"\\nccw \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token operator\"\n  }, \"=\"), \" \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \"(\"), \"command \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token operator\"\n  }, \"===\"), \" \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token string\"\n  }, \"\\\"G3\\\"\"), mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \")\"), \"\\n\")), mdx(\"p\", null, mdx(\"img\", {\n    parentName: \"p\",\n    \"src\": \"./drawing.png\",\n    \"alt\": \"The parameters and their relation\"\n  })), mdx(\"p\", null, \"My first guess was that the result of this conversion was somehow different between Firefox and Chrome, and so I modified the GCode viewer to log\\nthe calculated values and then compared the two outcomes. The values were completely identical between both browsers, so what was being fed\\ninto the canvas \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"arc\"), \" command was identical and yet produces different results. Why?\"), mdx(\"p\", null, \"My next approach was to add some more visual debug output to the viewer itself. I modified it such that the arc parameters as calculated would\\nactually be drawn on the canvas as well, in form of a geometrical pizza slice showing the arc's center, its \\\"legs\\\" and its rim. And this is where\\nI saw a difference in the rendered output. Where in Firefox the arc's rim and its legs met perfectly:\"), mdx(\"p\", null, mdx(\"img\", {\n    parentName: \"p\",\n    \"src\": \"./arc_ff.png\",\n    \"alt\": \"The arc in Firefox is rendered correctly\"\n  })), mdx(\"p\", null, \"in Chrome the rim overshot:\"), mdx(\"p\", null, mdx(\"img\", {\n    parentName: \"p\",\n    \"src\": \"./arc_chrome.png\",\n    \"alt\": \"The same arc in Chrome is rendered wrong\"\n  })), mdx(\"p\", null, \"So while the calculated parameters were correct and in both cases provided to the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"arc\"), \" method just the same, Chrome was rendering the wrong segment length! \"), mdx(\"p\", null, \"I suspected a rounding error and thus started searching for matching reports from other people. I couldn't find a specific bug report, but I came across a post on Stack Overflow that sounded mightily familiar: \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://stackoverflow.com/questions/8603656/html5-canvas-arcs-not-rendering-correctly-in-google-chrome\"\n  }, \"HTML5 canvas arcs not rendering correctly in Google Chrome\"), \", from 2011. A ten year old post... could it be?\"), mdx(\"p\", null, \"Honestly, I still do not know if this indeed described the same issue or not, or if there's a Chrome ticket describing this behaviour -- I'll continue to look, but first and foremost I was focused on fixing this problem in OctoPrint's GCode viewer. The Stack Overflow post provided a code snippet that reimplements \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"arc\"), \" utilizing bezier curves, and so I gave this a try. Long story short, OctoPrint's GCode Viewer as part of version 1.7.0+ will ship with a Chrome-only \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"arc\"), \" replacement that will be enabled by default, but can also be disabled in real time, with great effect:\"), mdx(\"p\", null, mdx(\"img\", {\n    parentName: \"p\",\n    \"src\": \"./arc_fix.gif\",\n    \"alt\": \"Enabling and disabling the arc workaround makes the defects disappear and reappear\"\n  })), mdx(\"p\", null, \"And the moral of the story: It rarely is a browser bug. But sometimes, all signs say it indeed \", mdx(\"em\", {\n    parentName: \"p\"\n  }, \"is\"), \" and a workaround is the easiest solution.\"));\n}\n\n;\nMDXContent.isMDXComponent = true;","renderedOutput":"<p>About a week ago I got a new <a pathname=\"/blog/2021-05-09-a-debugging-story\" href=\"https://github.com/OctoPrint/OctoPrint/issues/4117\">bug report</a> on <a pathname=\"/blog/2021-05-09-a-debugging-story\" href=\"https://octoprint.org\">OctoPrint&#x27;s</a> issue tracker:</p><blockquote><p><strong>GCode Viewer Visualisation Problem</strong></p><p><em>The problem</em></p><p>The visualisation in GCode viewer ist not correct. The print is OK.\nSee gcode file (zip) on Layer 43 to 47 and 49</p><p>And screenshot</p></blockquote><p>You already saw the included screenshot, and it shows that there was a spike being visualized in the GCode Viewer that\nwasn&#x27;t actually there. My first attempt at reproduction failed spectacularly -- the file looked exactly like\nit was supposed to. Then I noticed that the OP was using Google Chrome however (adding the detected user agent\nto the system information contained in OctoPrint&#x27;s new System Info Bundles already paid off!) and tried with that\ninstead of my usual Firefox, and lo and behold, I saw the issue.</p><p>Scrolling a bit through the file revealed further defects, as also mentioned by the OP, e.g. this one:</p><p><img pathname=\"/blog/2021-05-09-a-debugging-story\" src=\"/assets/content/blog/2021-05-09-a-debugging-story/issue_4117_2.png\" alt=\"Another defect, this time a whole part of the outline is being misplaced\"/></p><p>At this point it was clear that this was a Chrome-only issue. But was it a bug in OctoPrint or possibly a browser\nbug? More information for that was needed but not readily available, and the file was also too big to quickly\ngleam anything from the GCode itself that could possibly help to narrow down on the problem. </p><p>So the first step was to create a minimal GCode file that showed the same error. For this I took a look at\nthe reported layer height in the viewer on the layer a defect was visible and then narrowed down on the affected lines\nby using the horizontal command sliders to further limit the view. That way I quickly found that these were the\nproblematic lines:</p><pre class=\"language-gcode\"><code class=\"language-gcode\">G1 X173.595 Y103.9 E247.16716\nG3 X173.600 Y126.097 I-105613.507 J39.645 E248.20080\nG1 X169.552 Y126.098 E248.38933\n</code></pre><p>More specifically, the error was caused by the contained <a pathname=\"/blog/2021-05-09-a-debugging-story\" href=\"https://reprap.org/wiki/G-code#G2_.26_G3:_Controlled_Arc_Move\"><code>G3</code> command</a>,\nwhich instructs the printer to move in a counter clockwise arc\nfrom its current position to the given X and Y coordinates, with the center of said arc offset by the given I and J\nparameters. In the case of these lines, that meant to move in an arc from <code>(173.595, 103.0)</code> to <code>(173.600, 126.097)</code>\nwith the arc&#x27;s center at <code>x = 173.595 + (-105613.507) = -105439.912</code> and <code>y = 103.9 + 39.645 = 143.54500000000002</code>.\nOr in other words, a rather short arc with an enormous radius of over 105m that was more a straight line than\nan arc really. And that line was being drawn too long, causing the weird spike in the rendition.</p><p>In order to understand how that could happen however we need to take a look at how the GCode viewer is implemented and how\narcs work in that implementation. At its core, the GCode viewer is an HTML5 2D canvas on which the path described in\na GCode file gets drawn. Commands like <code>G0</code> and <code>G1</code> that describe straight lines are drawn using <a pathname=\"/blog/2021-05-09-a-debugging-story\" href=\"https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/lineTo\"><code>lineTo</code></a>,\narcs as described by <code>G2</code> and <code>G3</code> are drawn using <a pathname=\"/blog/2021-05-09-a-debugging-story\" href=\"https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/arc\"><code>arc</code></a>.</p><p><code>arc</code> takes six parameters: the <code>x</code> and <code>y</code> coordinate of the center of the arc, the radius <code>r</code>, the <code>startAngle</code> determining from which angle to start\ndrawing the arc and the <code>endAngle</code> until which to draw the arc, and a flag that&#x27;s <code>true</code> for counter clockwise and <code>false</code> or empty for clockwise.\nIt is obvious this doesn&#x27;t directly translate to the data contained in the GCode itself, where we rather have three points defining the arc -- a start\npoint, and end point, and the arc&#x27;s center. So we need to translate this into the data required by the <code>arc</code> method. Using some trigonometry,\nthat is fairly straightforward:</p><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// given: G2/G3 X&lt;endX&gt; Y&lt;endY&gt; I&lt;i&gt; J&lt;j&gt;, &lt;startX&gt;, &lt;startY&gt;</span>\narcX <span class=\"token operator\">=</span> startX <span class=\"token operator\">+</span> i<span class=\"token punctuation\">;</span>\narcY <span class=\"token operator\">=</span> startY <span class=\"token operator\">+</span> j<span class=\"token punctuation\">;</span>\nr <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">sqrt</span><span class=\"token punctuation\">(</span>i <span class=\"token operator\">*</span> i <span class=\"token operator\">+</span> j <span class=\"token operator\">*</span> j<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nstartAngle <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">atan2</span><span class=\"token punctuation\">(</span>startY <span class=\"token operator\">-</span> arcY<span class=\"token punctuation\">,</span> startX <span class=\"token operator\">-</span> arcX<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nendAngle <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">atan2</span><span class=\"token punctuation\">(</span>endY <span class=\"token operator\">-</span> arcY<span class=\"token punctuation\">,</span> endX <span class=\"token operator\">-</span> arcX<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nccw <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>command <span class=\"token operator\">===</span> <span class=\"token string\">&quot;G3&quot;</span><span class=\"token punctuation\">)</span>\n</code></pre><p><img pathname=\"/blog/2021-05-09-a-debugging-story\" src=\"/assets/content/blog/2021-05-09-a-debugging-story/drawing.png\" alt=\"The parameters and their relation\"/></p><p>My first guess was that the result of this conversion was somehow different between Firefox and Chrome, and so I modified the GCode viewer to log\nthe calculated values and then compared the two outcomes. The values were completely identical between both browsers, so what was being fed\ninto the canvas <code>arc</code> command was identical and yet produces different results. Why?</p><p>My next approach was to add some more visual debug output to the viewer itself. I modified it such that the arc parameters as calculated would\nactually be drawn on the canvas as well, in form of a geometrical pizza slice showing the arc&#x27;s center, its &quot;legs&quot; and its rim. And this is where\nI saw a difference in the rendered output. Where in Firefox the arc&#x27;s rim and its legs met perfectly:</p><p><img pathname=\"/blog/2021-05-09-a-debugging-story\" src=\"/assets/content/blog/2021-05-09-a-debugging-story/arc_ff.png\" alt=\"The arc in Firefox is rendered correctly\"/></p><p>in Chrome the rim overshot:</p><p><img pathname=\"/blog/2021-05-09-a-debugging-story\" src=\"/assets/content/blog/2021-05-09-a-debugging-story/arc_chrome.png\" alt=\"The same arc in Chrome is rendered wrong\"/></p><p>So while the calculated parameters were correct and in both cases provided to the <code>arc</code> method just the same, Chrome was rendering the wrong segment length! </p><p>I suspected a rounding error and thus started searching for matching reports from other people. I couldn&#x27;t find a specific bug report, but I came across a post on Stack Overflow that sounded mightily familiar: <a pathname=\"/blog/2021-05-09-a-debugging-story\" href=\"https://stackoverflow.com/questions/8603656/html5-canvas-arcs-not-rendering-correctly-in-google-chrome\">HTML5 canvas arcs not rendering correctly in Google Chrome</a>, from 2011. A ten year old post... could it be?</p><p>Honestly, I still do not know if this indeed described the same issue or not, or if there&#x27;s a Chrome ticket describing this behaviour -- I&#x27;ll continue to look, but first and foremost I was focused on fixing this problem in OctoPrint&#x27;s GCode viewer. The Stack Overflow post provided a code snippet that reimplements <code>arc</code> utilizing bezier curves, and so I gave this a try. Long story short, OctoPrint&#x27;s GCode Viewer as part of version 1.7.0+ will ship with a Chrome-only <code>arc</code> replacement that will be enabled by default, but can also be disabled in real time, with great effect:</p><p><img pathname=\"/blog/2021-05-09-a-debugging-story\" src=\"/assets/content/blog/2021-05-09-a-debugging-story/arc_fix.gif\" alt=\"Enabling and disabling the arc workaround makes the defects disappear and reappear\"/></p><p>And the moral of the story: It rarely is a browser bug. But sometimes, all signs say it indeed <em>is</em> and a workaround is the easiest solution.</p>","scope":{}}},"seo":{"title":"A debugging story","description":"Could this bug for once not be my fault?","openGraph":{"title":"A debugging story","url":"https://foosel.net/blog/2021-05-09-a-debugging-story","description":"Could this bug for once not be my fault?","images":[{"url":"https://foosel.net/assets/content/blog/2021-05-09-a-debugging-story/issue_4117.png","alt":"The screenshot showing the issue -- a rendering defect in OctoPrint's GCode viewer","external":"https://foosel.net/assets/content/blog/2021-05-09-a-debugging-story/issue_4117.png"}],"type":"article","article":{"publishedTime":"2021-05-09T00:00:00Z","modifiedTime":"2021-05-09T00:00:00Z"}}},"previous":{"link":"/blog/2021-03-28-homelab-uplink-monitoring","title":"Homelab uplink monitoring"},"next":null},"__N_SSG":true}