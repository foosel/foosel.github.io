{"pageProps":{"post":{"slug":"2022-01-03-tfa-dostmann-meets-esphome","title":"TFA Dostmann meets ESPHome","subtitle":"Integrating a CO2 sensor into my HA setup","image":{"url":"/assets/content/blog/2022-01-03-tfa-dostmann-meets-esphome/tfa-dostmann-front.jpg","alt":"A TFA Dostmann CO2 sensor","external":"https://foosel.net/assets/content/blog/2022-01-03-tfa-dostmann-meets-esphome/tfa-dostmann-front.jpg"},"content":"\nI attended RC3 from December 27th until December 30th. While it was (once again)\nonly a virtual edition of the Chaos Communication Congress, at least this time\naround I managed to have a similar experience to 36c3, as in, I spent the last two days\nmostly hanging out with a bunch of fellow geeks in a fun location (a jitsi conference\nthat also included a camera pointing at an aquarium full of fish) and nerding out\nwhile tinkering around with electronics.\n\nAnd thus I finally integrated the CO2 sensor unit I bought a couple weeks ago into\nmy Home Automation setup, with the help of a Wemos D1 Mini and [ESPHome](https://esphome.io). At first\nI went with an ESP12, a voltage regulator and a [different firmware](https://github.com/schinken/esp8266-co2monitor),\nbut that didn't work out due to the ESP not wanting to behave (my guess is I didn't wire the barebone module\nup correctly or the voltage regulator was causing issues) and I also got some weird readings \nreported by the firmware (20k ppm CO2 - I know the air in my office can get bad after a couple of hours of\ncoding, but not THAT bad).\n\nThe CO2 sensor is an \"AIRCO2NTROL MINI\" from TFA Dostmann, but it is also available under other names\nwith a very similar case and more or less the same internals, as I learned from the\n[ESPHome docs](https://esphome.io/components/sensor/zyaura.html). Where my Dostmann edition seems to differ from the majority is the\npin order of the internal debug port, which turned out to have CLK and DATA swapped\nin my case, which caused me quite the headache and a bit of frustration. So just for future reference,\nthe pin order I found in my device is 5V - Data - CLK - Gnd from left to right with the hose to the left:\n\n![The pinout of the sensor's debug port, 5V - Data - CLK - Gnd](./tfa-dostmann-pinout.jpg)\n\nI hooked these up to the Wemos D1 Mini (clone) like this:\n\n![A wiring diagram of how to hookup the Wemos D1 mini to the debug port, 5V to 5V, Gnd to Gnd, Data to D1 and CLK to D2](./tfa-dostmann-wemos-d1-wiring.png)\n\nSo 5V to 5V, Gnd to Gnd, Data to D1 and CLK to D2.\n\nThe ESPHome config I then flashed to the D1 is the following:\n\n``` yaml\nesphome:\n  name: dostmann-office\n  platform: ESP8266\n  board: d1_mini\n\nlogger:\n\nmqtt:\n  broker: !secret mqtt_iot_broker\n\nota:\n  password: !secret ota_pass\n\nwifi:\n  ssid: !secret wifi_iot_ssid\n  password: !secret wifi_iot_pass\n  ap:\n    ssid: \"Dostmann Office Fallback\"\n    password: !secret fallback_pass\n  power_save_mode: high\n\ncaptive_portal:\n\nsensor:\n  - platform: zyaura\n    clock_pin: D2\n    data_pin: D1\n    co2:\n      name: \"Office Dostmann CO2\"\n    temperature:\n      name: \"Office Dostmann Temperature\"\n\n  - platform: wifi_signal\n    name: \"Office Dostmann WiFi Signal\"\n    update_interval: 60s\n```\n\n(If you are wondering about the `!secret` stuff, those values are contained in \na `secret.yaml` file in my esphome folder, and you can read all about that\n[in the ESPHome docs here](https://esphome.io/guides/faq.html#tips-for-using-esphome).)\n\nAnd with that I could now see the sensor in my Home Assistant instance and forward the data\neasily to my InfluxDB & Grafana monitoring stack.\n\nTo put everything together physically, fully contained, I used [this alternative backplate](https://www.thingiverse.com/thing:4225732)\nby Stefan Kern. \n\n![The alternative backplate in place, closing up the sensor and containing the Wemos D1 Mini as well](./tfa-dostmann-back.jpg)\n\nHowever, I've noticed a temperature increase of around 3Â°C with it and the ESP\nin place, and I fear this might be screwing with the CO2 sensor's calibration (as the measurement\nis temperature sensitive). I already mitigated this a bit by setting the chip to power save and adding some strategically placed aluminium tape,\nbut that's only improved things slightly. Due to that I plan to redesign the \nbackplate to have the ESP outside the sensor case, in its own compartment. I \nhope that will solve the \"running hot\" issue for good then, but we'll see.\n\n*Update from January 27th 2022* I redesigned the backplate and now have a solution that seems to work better, based on the reported temperature and CO2. [I've published it here](https://www.prusaprinters.org/prints/119968-airco2ntrol-mini-backplate-with-wemos-d1-mini).\n\nIn any case, for now I at least got a reliable indicator of my office's CO2 levels that also now\nare trackable long term, and I have also forwarded the current values to my [AWTRIX mini](https://awtrixdocs.blueforcer.de/)\nvia some NodeRED flow that also takes care of color coding. Further possibilities include\nflashing the office lights or some audio cues, should just the visual warning turn out\nto be insufficient in the long term ðŸ˜‰\n\n![CO2 sensor data graphed over two days](./grafana-co2.png)\n","assets":[{"slug":"2022-01-03-tfa-dostmann-meets-esphome","asset":"grafana-co2.png","path":"/home/runner/work/foosel.github.io/foosel.github.io/content/posts/2022-01-03-tfa-dostmann-meets-esphome/grafana-co2.png"},{"slug":"2022-01-03-tfa-dostmann-meets-esphome","asset":"tfa-dostmann-back.jpg","path":"/home/runner/work/foosel.github.io/foosel.github.io/content/posts/2022-01-03-tfa-dostmann-meets-esphome/tfa-dostmann-back.jpg"},{"slug":"2022-01-03-tfa-dostmann-meets-esphome","asset":"tfa-dostmann-front.jpg","path":"/home/runner/work/foosel.github.io/foosel.github.io/content/posts/2022-01-03-tfa-dostmann-meets-esphome/tfa-dostmann-front.jpg"},{"slug":"2022-01-03-tfa-dostmann-meets-esphome","asset":"tfa-dostmann-pinout.jpg","path":"/home/runner/work/foosel.github.io/foosel.github.io/content/posts/2022-01-03-tfa-dostmann-meets-esphome/tfa-dostmann-pinout.jpg"},{"slug":"2022-01-03-tfa-dostmann-meets-esphome","asset":"tfa-dostmann-wemos-d1-wiring.png","path":"/home/runner/work/foosel.github.io/foosel.github.io/content/posts/2022-01-03-tfa-dostmann-meets-esphome/tfa-dostmann-wemos-d1-wiring.png"}],"published":"2022-01-03T00:00:00Z","readingtime":{"text":"4 min read","minutes":3.715,"time":222900,"words":743},"mdx":{"compiledSource":"\"use strict\";\n\nvar _excluded = [\"components\"];\nfunction _extends() { _extends = Object.assign ? Object.assign.bind() : function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n/* @jsxRuntime classic */\n/* @jsx mdx */\n\nvar layoutProps = {};\nvar MDXLayout = \"wrapper\";\nfunction MDXContent(_ref) {\n  var components = _ref.components,\n    props = _objectWithoutProperties(_ref, _excluded);\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"p\", null, \"I attended RC3 from December 27th until December 30th. While it was (once again)\\nonly a virtual edition of the Chaos Communication Congress, at least this time\\naround I managed to have a similar experience to 36c3, as in, I spent the last two days\\nmostly hanging out with a bunch of fellow geeks in a fun location (a jitsi conference\\nthat also included a camera pointing at an aquarium full of fish) and nerding out\\nwhile tinkering around with electronics.\"), mdx(\"p\", null, \"And thus I finally integrated the CO2 sensor unit I bought a couple weeks ago into\\nmy Home Automation setup, with the help of a Wemos D1 Mini and \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://esphome.io\"\n  }, \"ESPHome\"), \". At first\\nI went with an ESP12, a voltage regulator and a \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://github.com/schinken/esp8266-co2monitor\"\n  }, \"different firmware\"), \",\\nbut that didn't work out due to the ESP not wanting to behave (my guess is I didn't wire the barebone module\\nup correctly or the voltage regulator was causing issues) and I also got some weird readings\\nreported by the firmware (20k ppm CO2 - I know the air in my office can get bad after a couple of hours of\\ncoding, but not THAT bad).\"), mdx(\"p\", null, \"The CO2 sensor is an \\\"AIRCO2NTROL MINI\\\" from TFA Dostmann, but it is also available under other names\\nwith a very similar case and more or less the same internals, as I learned from the\\n\", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://esphome.io/components/sensor/zyaura.html\"\n  }, \"ESPHome docs\"), \". Where my Dostmann edition seems to differ from the majority is the\\npin order of the internal debug port, which turned out to have CLK and DATA swapped\\nin my case, which caused me quite the headache and a bit of frustration. So just for future reference,\\nthe pin order I found in my device is 5V - Data - CLK - Gnd from left to right with the hose to the left:\"), mdx(\"p\", null, mdx(\"img\", {\n    parentName: \"p\",\n    \"src\": \"./tfa-dostmann-pinout.jpg\",\n    \"alt\": \"The pinout of the sensor's debug port, 5V - Data - CLK - Gnd\"\n  })), mdx(\"p\", null, \"I hooked these up to the Wemos D1 Mini (clone) like this:\"), mdx(\"p\", null, mdx(\"img\", {\n    parentName: \"p\",\n    \"src\": \"./tfa-dostmann-wemos-d1-wiring.png\",\n    \"alt\": \"A wiring diagram of how to hookup the Wemos D1 mini to the debug port, 5V to 5V, Gnd to Gnd, Data to D1 and CLK to D2\"\n  })), mdx(\"p\", null, \"So 5V to 5V, Gnd to Gnd, Data to D1 and CLK to D2.\"), mdx(\"p\", null, \"The ESPHome config I then flashed to the D1 is the following:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-yaml\"\n  }, \"esphome:\\n  name: dostmann-office\\n  platform: ESP8266\\n  board: d1_mini\\n\\nlogger:\\n\\nmqtt:\\n  broker: !secret mqtt_iot_broker\\n\\nota:\\n  password: !secret ota_pass\\n\\nwifi:\\n  ssid: !secret wifi_iot_ssid\\n  password: !secret wifi_iot_pass\\n  ap:\\n    ssid: \\\"Dostmann Office Fallback\\\"\\n    password: !secret fallback_pass\\n  power_save_mode: high\\n\\ncaptive_portal:\\n\\nsensor:\\n  - platform: zyaura\\n    clock_pin: D2\\n    data_pin: D1\\n    co2:\\n      name: \\\"Office Dostmann CO2\\\"\\n    temperature:\\n      name: \\\"Office Dostmann Temperature\\\"\\n\\n  - platform: wifi_signal\\n    name: \\\"Office Dostmann WiFi Signal\\\"\\n    update_interval: 60s\\n\")), mdx(\"p\", null, \"(If you are wondering about the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"!secret\"), \" stuff, those values are contained in\\na \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"secret.yaml\"), \" file in my esphome folder, and you can read all about that\\n\", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://esphome.io/guides/faq.html#tips-for-using-esphome\"\n  }, \"in the ESPHome docs here\"), \".)\"), mdx(\"p\", null, \"And with that I could now see the sensor in my Home Assistant instance and forward the data\\neasily to my InfluxDB & Grafana monitoring stack.\"), mdx(\"p\", null, \"To put everything together physically, fully contained, I used \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://www.thingiverse.com/thing:4225732\"\n  }, \"this alternative backplate\"), \"\\nby Stefan Kern. \"), mdx(\"p\", null, mdx(\"img\", {\n    parentName: \"p\",\n    \"src\": \"./tfa-dostmann-back.jpg\",\n    \"alt\": \"The alternative backplate in place, closing up the sensor and containing the Wemos D1 Mini as well\"\n  })), mdx(\"p\", null, \"However, I've noticed a temperature increase of around 3\\xB0C with it and the ESP\\nin place, and I fear this might be screwing with the CO2 sensor's calibration (as the measurement\\nis temperature sensitive). I already mitigated this a bit by setting the chip to power save and adding some strategically placed aluminium tape,\\nbut that's only improved things slightly. Due to that I plan to redesign the\\nbackplate to have the ESP outside the sensor case, in its own compartment. I\\nhope that will solve the \\\"running hot\\\" issue for good then, but we'll see.\"), mdx(\"p\", null, mdx(\"em\", {\n    parentName: \"p\"\n  }, \"Update from January 27th 2022\"), \" I redesigned the backplate and now have a solution that seems to work better, based on the reported temperature and CO2. \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://www.prusaprinters.org/prints/119968-airco2ntrol-mini-backplate-with-wemos-d1-mini\"\n  }, \"I've published it here\"), \".\"), mdx(\"p\", null, \"In any case, for now I at least got a reliable indicator of my office's CO2 levels that also now\\nare trackable long term, and I have also forwarded the current values to my \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://awtrixdocs.blueforcer.de/\"\n  }, \"AWTRIX mini\"), \"\\nvia some NodeRED flow that also takes care of color coding. Further possibilities include\\nflashing the office lights or some audio cues, should just the visual warning turn out\\nto be insufficient in the long term \\uD83D\\uDE09\"), mdx(\"p\", null, mdx(\"img\", {\n    parentName: \"p\",\n    \"src\": \"./grafana-co2.png\",\n    \"alt\": \"CO2 sensor data graphed over two days\"\n  })));\n}\n;\nMDXContent.isMDXComponent = true;","renderedOutput":"<p>I attended RC3 from December 27th until December 30th. While it was (once again)\nonly a virtual edition of the Chaos Communication Congress, at least this time\naround I managed to have a similar experience to 36c3, as in, I spent the last two days\nmostly hanging out with a bunch of fellow geeks in a fun location (a jitsi conference\nthat also included a camera pointing at an aquarium full of fish) and nerding out\nwhile tinkering around with electronics.</p><p>And thus I finally integrated the CO2 sensor unit I bought a couple weeks ago into\nmy Home Automation setup, with the help of a Wemos D1 Mini and <a pathname=\"/blog/2022-01-03-tfa-dostmann-meets-esphome\" href=\"https://esphome.io\">ESPHome</a>. At first\nI went with an ESP12, a voltage regulator and a <a pathname=\"/blog/2022-01-03-tfa-dostmann-meets-esphome\" href=\"https://github.com/schinken/esp8266-co2monitor\">different firmware</a>,\nbut that didn&#x27;t work out due to the ESP not wanting to behave (my guess is I didn&#x27;t wire the barebone module\nup correctly or the voltage regulator was causing issues) and I also got some weird readings\nreported by the firmware (20k ppm CO2 - I know the air in my office can get bad after a couple of hours of\ncoding, but not THAT bad).</p><p>The CO2 sensor is an &quot;AIRCO2NTROL MINI&quot; from TFA Dostmann, but it is also available under other names\nwith a very similar case and more or less the same internals, as I learned from the\n<a pathname=\"/blog/2022-01-03-tfa-dostmann-meets-esphome\" href=\"https://esphome.io/components/sensor/zyaura.html\">ESPHome docs</a>. Where my Dostmann edition seems to differ from the majority is the\npin order of the internal debug port, which turned out to have CLK and DATA swapped\nin my case, which caused me quite the headache and a bit of frustration. So just for future reference,\nthe pin order I found in my device is 5V - Data - CLK - Gnd from left to right with the hose to the left:</p><p><img pathname=\"/blog/2022-01-03-tfa-dostmann-meets-esphome\" src=\"/assets/content/blog/2022-01-03-tfa-dostmann-meets-esphome/tfa-dostmann-pinout.jpg\" alt=\"The pinout of the sensor&#x27;s debug port, 5V - Data - CLK - Gnd\"/></p><p>I hooked these up to the Wemos D1 Mini (clone) like this:</p><p><img pathname=\"/blog/2022-01-03-tfa-dostmann-meets-esphome\" src=\"/assets/content/blog/2022-01-03-tfa-dostmann-meets-esphome/tfa-dostmann-wemos-d1-wiring.png\" alt=\"A wiring diagram of how to hookup the Wemos D1 mini to the debug port, 5V to 5V, Gnd to Gnd, Data to D1 and CLK to D2\"/></p><p>So 5V to 5V, Gnd to Gnd, Data to D1 and CLK to D2.</p><p>The ESPHome config I then flashed to the D1 is the following:</p><pre><code class=\"language-yaml\">esphome:\n  name: dostmann-office\n  platform: ESP8266\n  board: d1_mini\n\nlogger:\n\nmqtt:\n  broker: !secret mqtt_iot_broker\n\nota:\n  password: !secret ota_pass\n\nwifi:\n  ssid: !secret wifi_iot_ssid\n  password: !secret wifi_iot_pass\n  ap:\n    ssid: &quot;Dostmann Office Fallback&quot;\n    password: !secret fallback_pass\n  power_save_mode: high\n\ncaptive_portal:\n\nsensor:\n  - platform: zyaura\n    clock_pin: D2\n    data_pin: D1\n    co2:\n      name: &quot;Office Dostmann CO2&quot;\n    temperature:\n      name: &quot;Office Dostmann Temperature&quot;\n\n  - platform: wifi_signal\n    name: &quot;Office Dostmann WiFi Signal&quot;\n    update_interval: 60s\n</code></pre><p>(If you are wondering about the <code>!secret</code> stuff, those values are contained in\na <code>secret.yaml</code> file in my esphome folder, and you can read all about that\n<a pathname=\"/blog/2022-01-03-tfa-dostmann-meets-esphome\" href=\"https://esphome.io/guides/faq.html#tips-for-using-esphome\">in the ESPHome docs here</a>.)</p><p>And with that I could now see the sensor in my Home Assistant instance and forward the data\neasily to my InfluxDB &amp; Grafana monitoring stack.</p><p>To put everything together physically, fully contained, I used <a pathname=\"/blog/2022-01-03-tfa-dostmann-meets-esphome\" href=\"https://www.thingiverse.com/thing:4225732\">this alternative backplate</a>\nby Stefan Kern. </p><p><img pathname=\"/blog/2022-01-03-tfa-dostmann-meets-esphome\" src=\"/assets/content/blog/2022-01-03-tfa-dostmann-meets-esphome/tfa-dostmann-back.jpg\" alt=\"The alternative backplate in place, closing up the sensor and containing the Wemos D1 Mini as well\"/></p><p>However, I&#x27;ve noticed a temperature increase of around 3Â°C with it and the ESP\nin place, and I fear this might be screwing with the CO2 sensor&#x27;s calibration (as the measurement\nis temperature sensitive). I already mitigated this a bit by setting the chip to power save and adding some strategically placed aluminium tape,\nbut that&#x27;s only improved things slightly. Due to that I plan to redesign the\nbackplate to have the ESP outside the sensor case, in its own compartment. I\nhope that will solve the &quot;running hot&quot; issue for good then, but we&#x27;ll see.</p><p><em>Update from January 27th 2022</em> I redesigned the backplate and now have a solution that seems to work better, based on the reported temperature and CO2. <a pathname=\"/blog/2022-01-03-tfa-dostmann-meets-esphome\" href=\"https://www.prusaprinters.org/prints/119968-airco2ntrol-mini-backplate-with-wemos-d1-mini\">I&#x27;ve published it here</a>.</p><p>In any case, for now I at least got a reliable indicator of my office&#x27;s CO2 levels that also now\nare trackable long term, and I have also forwarded the current values to my <a pathname=\"/blog/2022-01-03-tfa-dostmann-meets-esphome\" href=\"https://awtrixdocs.blueforcer.de/\">AWTRIX mini</a>\nvia some NodeRED flow that also takes care of color coding. Further possibilities include\nflashing the office lights or some audio cues, should just the visual warning turn out\nto be insufficient in the long term ðŸ˜‰</p><p><img pathname=\"/blog/2022-01-03-tfa-dostmann-meets-esphome\" src=\"/assets/content/blog/2022-01-03-tfa-dostmann-meets-esphome/grafana-co2.png\" alt=\"CO2 sensor data graphed over two days\"/></p>","scope":{}}},"seo":{"title":"TFA Dostmann meets ESPHome","description":"Integrating a CO2 sensor into my HA setup","openGraph":{"title":"TFA Dostmann meets ESPHome","url":"https://foosel.net/blog/2022-01-03-tfa-dostmann-meets-esphome","description":"Integrating a CO2 sensor into my HA setup","images":[{"url":"https://foosel.net/assets/content/blog/2022-01-03-tfa-dostmann-meets-esphome/tfa-dostmann-front.jpg","alt":"A TFA Dostmann CO2 sensor","external":"https://foosel.net/assets/content/blog/2022-01-03-tfa-dostmann-meets-esphome/tfa-dostmann-front.jpg"}],"type":"article","article":{"publishedTime":"2022-01-03T00:00:00Z","modifiedTime":"2022-01-03T00:00:00Z"}}},"previous":{"link":"/blog/2021-09-28-being-patient-with-yourself-is-hard","title":"Being patient with yourself is hard"},"next":null},"__N_SSG":true}