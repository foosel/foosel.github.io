<!DOCTYPE html><html lang="en"><head><link rel="stylesheet" href="/assets/fonts/economica/font.css"/><link rel="stylesheet" href="/assets/fonts/palanquin/font.css"/><script type="text/javascript" src="/assets/js/darkmode.js"></script><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site" content="@foosel"/><meta name="twitter:creator" content="@foosel"/><meta property="og:locale" content="en"/><meta property="og:site_name" content="foosel.net"/><title>A debugging story | foosel.net</title><meta name="robots" content="index,follow"/><meta name="googlebot" content="index,follow"/><meta name="description" content="Could this bug for once not be my fault?"/><meta property="og:title" content="A debugging story"/><meta property="og:description" content="Could this bug for once not be my fault?"/><meta property="og:url" content="https://foosel.net/blog/2021-05-09-a-debugging-story"/><meta property="og:type" content="article"/><meta property="article:published_time" content="2021-05-09T00:00:00Z"/><meta property="article:modified_time" content="2021-05-09T00:00:00Z"/><meta property="og:image" content="https://foosel.net/assets/content/blog/2021-05-09-a-debugging-story/issue_4117.png"/><meta property="og:image:alt" content="The screenshot showing the issue -- a rendering defect in OctoPrint&#x27;s GCode viewer"/><meta name="next-head-count" content="19"/><link rel="preload" href="/_next/static/css/99f79fd98d542b376485.css" as="style"/><link rel="stylesheet" href="/_next/static/css/99f79fd98d542b376485.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a40ef1678bae11e696dba45124eadd70.js"></script><script src="/_next/static/chunks/webpack-fb76148cfcfb42ca18eb.js" defer=""></script><script src="/_next/static/chunks/framework-1a85486469afb3278dba.js" defer=""></script><script src="/_next/static/chunks/main-c5c678ba45d45bf9d8f5.js" defer=""></script><script src="/_next/static/chunks/pages/_app-f699609187394af3a696.js" defer=""></script><script src="/_next/static/chunks/465-9050204e68dafc3e13af.js" defer=""></script><script src="/_next/static/chunks/804-48023baaccf128bb1e47.js" defer=""></script><script src="/_next/static/chunks/154-4cdb215d6f6cb7ee3ca8.js" defer=""></script><script src="/_next/static/chunks/608-a6bd458a362b3c911e0b.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5Bslug%5D-4562f9736860a1374870.js" defer=""></script><script src="/_next/static/TZJjmG4P0nL75dt6pazby/_buildManifest.js" defer=""></script><script src="/_next/static/TZJjmG4P0nL75dt6pazby/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="flex flex-col min-h-screen"><nav class="fixed bg-black text-white p-4 w-full z-50"><div class="w-screen-sm xl:w-screen-md lg:mx-auto flex flex-col lg:flex-row content-end lg:justify-center"><div class="flex flex-row lg:absolute lg:left-4"><span class="justify-start"><a class="text-white uppercase font-semibold" href="/">foosel.net</a></span></div><div class="absolute right-4"><a class="justify-end hidden lg:inline" title="Toggle dark mode"><svg class="mdi-icon inline cursor-pointer" width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M12,18V6A6,6 0 0,1 18,12A6,6 0 0,1 12,18M20,15.31L23.31,12L20,8.69V4H15.31L12,0.69L8.69,4H4V8.69L0.69,12L4,15.31V20H8.69L12,23.31L15.31,20H20V15.31Z"></path></svg></a><span class="flex flex-row justify-end lg:hidden cursor-pointer"><div><svg class="mdi-icon " width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M3,6H21V8H3V6M3,11H21V13H3V11M3,16H21V18H3V16Z"></path></svg></div></span></div><ul class="flex-col mt-2 lg:mt-0 text-right lg:text-center lg:flex lg:flex-row lg:justify-end hidden"><li class="my-2 lg:my-0 lg:mx-4"><a class="text-white uppercase font-semibold" href="/">Home</a></li><li class="my-2 lg:my-0 lg:mx-4"><a class="text-white uppercase font-semibold" href="/about">About Me</a></li><li class="my-2 lg:my-0 lg:mx-4"><a class="text-white uppercase font-semibold" href="/blog">Blog</a></li><li class="my-2 lg:my-0 lg:mx-4"><a class="text-white uppercase font-semibold" href="/media">Media</a></li><li class="lg:hidden my-2"><a class="text-white uppercase font-semibold" title="Toggle dark mode"><svg class="mdi-icon inline cursor-pointer" width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M12,18V6A6,6 0 0,1 18,12A6,6 0 0,1 12,18M20,15.31L23.31,12L20,8.69V4H15.31L12,0.69L8.69,4H4V8.69L0.69,12L4,15.31V20H8.69L12,23.31L15.31,20H20V15.31Z"></path></svg></a></li></ul></div></nav><main class="container flex-grow mx-auto justify-content py-4 pt-20"><div class="flex flex-col max-w-screen-sm xl:max-w-screen-md mx-auto justify-content"><div class="flex flex-col space-y-4 mb-4"><h1 class="text-6xl md:text-7xl lg:text-8xl font-bold tracking-tighter text-center">A debugging story</h1><p class="text-3xl md:text-4xl lg:text-5xl text-center">Could this bug for once not be my fault?</p><p class="italic text-center">Posted on<!-- --> <time dateTime="2021-05-09T00:00:00Z">May	9, 2021</time></p><p class="text-center text-xs"><svg class="mdi-icon inline-block object-center" width="12" height="12" fill="currentColor" viewBox="0 0 24 24"><path d="M12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22C6.47,22 2,17.5 2,12A10,10 0 0,1 12,2M12.5,7V12.25L17,14.92L16.25,16.15L11,13V7H12.5Z"></path></svg> <!-- -->6 min read</p><img src="/assets/content/blog/2021-05-09-a-debugging-story/issue_4117.png" alt="The screenshot showing the issue -- a rendering defect in OctoPrint&#x27;s GCode viewer" class="w-full"/></div><div class="flex flex-col w-full px-4 mt-8"><article class="prose lg:prose-xl w-full mx-auto"><div><p>About a week ago I got a new <a pathname="/blog/2021-05-09-a-debugging-story" href="https://github.com/OctoPrint/OctoPrint/issues/4117">bug report</a> on <a pathname="/blog/2021-05-09-a-debugging-story" href="https://octoprint.org">OctoPrint&#x27;s</a> issue tracker:</p><blockquote><p><strong>GCode Viewer Visualisation Problem</strong></p><p><em>The problem</em></p><p>The visualisation in GCode viewer ist not correct. The print is OK.
See gcode file (zip) on Layer 43 to 47 and 49</p><p>And screenshot</p></blockquote><p>You already saw the included screenshot, and it shows that there was a spike being visualized in the GCode Viewer that
wasn&#x27;t actually there. My first attempt at reproduction failed spectacularly -- the file looked exactly like
it was supposed to. Then I noticed that the OP was using Google Chrome however (adding the detected user agent
to the system information contained in OctoPrint&#x27;s new System Info Bundles already paid off!) and tried with that
instead of my usual Firefox, and lo and behold, I saw the issue.</p><p>Scrolling a bit through the file revealed further defects, as also mentioned by the OP, e.g. this one:</p><p><img pathname="/blog/2021-05-09-a-debugging-story" src="/assets/content/blog/2021-05-09-a-debugging-story/issue_4117_2.png" alt="Another defect, this time a whole part of the outline is being misplaced"/></p><p>At this point it was clear that this was a Chrome-only issue. But was it a bug in OctoPrint or possibly a browser
bug? More information for that was needed but not readily available, and the file was also too big to quickly
gleam anything from the GCode itself that could possibly help to narrow down on the problem. </p><p>So the first step was to create a minimal GCode file that showed the same error. For this I took a look at
the reported layer height in the viewer on the layer a defect was visible and then narrowed down on the affected lines
by using the horizontal command sliders to further limit the view. That way I quickly found that these were the
problematic lines:</p><pre><code class="language-gcode">G1 X173.595 Y103.9 E247.16716
G3 X173.600 Y126.097 I-105613.507 J39.645 E248.20080
G1 X169.552 Y126.098 E248.38933
</code></pre><p>More specifically, the error was caused by the contained <a pathname="/blog/2021-05-09-a-debugging-story" href="https://reprap.org/wiki/G-code#G2_.26_G3:_Controlled_Arc_Move"><code>G3</code> command</a>,
which instructs the printer to move in a counter clockwise arc
from its current position to the given X and Y coordinates, with the center of said arc offset by the given I and J
parameters. In the case of these lines, that meant to move in an arc from <code>(173.595, 103.0)</code> to <code>(173.600, 126.097)</code>
with the arc&#x27;s center at <code>x = 173.595 + (-105613.507) = -105439.912</code> and <code>y = 103.9 + 39.645 = 143.54500000000002</code>.
Or in other words, a rather short arc with an enormous radius of over 105m that was more a straight line than
an arc really. And that line was being drawn too long, causing the weird spike in the rendition.</p><p>In order to understand how that could happen however we need to take a look at how the GCode viewer is implemented and how
arcs work in that implementation. At its core, the GCode viewer is an HTML5 2D canvas on which the path described in
a GCode file gets drawn. Commands like <code>G0</code> and <code>G1</code> that describe straight lines are drawn using <a pathname="/blog/2021-05-09-a-debugging-story" href="https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/lineTo"><code>lineTo</code></a>,
arcs as described by <code>G2</code> and <code>G3</code> are drawn using <a pathname="/blog/2021-05-09-a-debugging-story" href="https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/arc"><code>arc</code></a>.</p><p><code>arc</code> takes six parameters: the <code>x</code> and <code>y</code> coordinate of the center of the arc, the radius <code>r</code>, the <code>startAngle</code> determining from which angle to start
drawing the arc and the <code>endAngle</code> until which to draw the arc, and a flag that&#x27;s <code>true</code> for counter clockwise and <code>false</code> or empty for clockwise.
It is obvious this doesn&#x27;t directly translate to the data contained in the GCode itself, where we rather have three points defining the arc -- a start
point, and end point, and the arc&#x27;s center. So we need to translate this into the data required by the <code>arc</code> method. Using some trigonometry,
that is fairly straightforward:</p><pre><code class="language-js">// given: G2/G3 X&lt;endX&gt; Y&lt;endY&gt; I&lt;i&gt; J&lt;j&gt;, &lt;startX&gt;, &lt;startY&gt;
arcX = startX + i;
arcY = startY + j;
r = Math.sqrt(i * i + j * j);
startAngle = Math.atan2(startY - arcY, startX - arcX);
endAngle = Math.atan2(endY - arcY, endX - arcX);
ccw = (command === &quot;G3&quot;)
</code></pre><p><img pathname="/blog/2021-05-09-a-debugging-story" src="/assets/content/blog/2021-05-09-a-debugging-story/drawing.png" alt="The parameters and their relation"/></p><p>My first guess was that the result of this conversion was somehow different between Firefox and Chrome, and so I modified the GCode viewer to log
the calculated values and then compared the two outcomes. The values were completely identical between both browsers, so what was being fed
into the canvas <code>arc</code> command was identical and yet produces different results. Why?</p><p>My next approach was to add some more visual debug output to the viewer itself. I modified it such that the arc parameters as calculated would
actually be drawn on the canvas as well, in form of a geometrical pizza slice showing the arc&#x27;s center, its &quot;legs&quot; and its rim. And this is where
I saw a difference in the rendered output. Where in Firefox the arc&#x27;s rim and its legs met perfectly:</p><p><img pathname="/blog/2021-05-09-a-debugging-story" src="/assets/content/blog/2021-05-09-a-debugging-story/arc_ff.png" alt="The arc in Firefox is rendered correctly"/></p><p>in Chrome the rim overshot:</p><p><img pathname="/blog/2021-05-09-a-debugging-story" src="/assets/content/blog/2021-05-09-a-debugging-story/arc_chrome.png" alt="The same arc in Chrome is rendered wrong"/></p><p>So while the calculated parameters were correct and in both cases provided to the <code>arc</code> method just the same, Chrome was rendering the wrong segment length! </p><p>I suspected a rounding error and thus started searching for matching reports from other people. I couldn&#x27;t find a specific bug report, but I came across a post on Stack Overflow that sounded mightily familiar: <a pathname="/blog/2021-05-09-a-debugging-story" href="https://stackoverflow.com/questions/8603656/html5-canvas-arcs-not-rendering-correctly-in-google-chrome">HTML5 canvas arcs not rendering correctly in Google Chrome</a>, from 2011. A ten year old post... could it be?</p><p>Honestly, I still do not know if this indeed described the same issue or not, or if there&#x27;s a Chrome ticket describing this behaviour -- I&#x27;ll continue to look, but first and foremost I was focused on fixing this problem in OctoPrint&#x27;s GCode viewer. The Stack Overflow post provided a code snippet that reimplements <code>arc</code> utilizing bezier curves, and so I gave this a try. Long story short, OctoPrint&#x27;s GCode Viewer as part of version 1.7.0+ will ship with a Chrome-only <code>arc</code> replacement that will be enabled by default, but can also be disabled in real time, with great effect:</p><p><img pathname="/blog/2021-05-09-a-debugging-story" src="/assets/content/blog/2021-05-09-a-debugging-story/arc_fix.gif" alt="Enabling and disabling the arc workaround makes the defects disappear and reappear"/></p><p>And the moral of the story: It rarely is a browser bug. But sometimes, all signs say it indeed <em>is</em> and a workaround is the easiest solution.</p></div></article><p class="flex flex-row mt-6 text-inherit text-sm"><a href="/blog/2021-09-12-hydroponics-the-kratky-way">← Hydroponics the Kratky way</a><span class="flex-1"></span><a href="/blog/2021-03-28-homelab-uplink-monitoring">Homelab uplink monitoring →</a></p></div></div></main><footer class="p-4 bg-black text-white"><div class="max-w-screen-sm xl:max-w-screen-md mx-auto flex flex-col"><p class="text-white text-center">Made with ❤ by<!-- --> <a href="/about">Gina Häußge</a></p><p class="text-white text-center"><a href="/legal">Legal Notice</a> ·<!-- --> <a href="/privacy">Privacy Policy</a> ·<!-- --> <a href="/feed/blog.atom">Feed</a></p></div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"slug":"2021-05-09-a-debugging-story","title":"A debugging story","subtitle":"Could this bug for once not be my fault?","image":{"url":"/assets/content/blog/2021-05-09-a-debugging-story/issue_4117.png","alt":"The screenshot showing the issue -- a rendering defect in OctoPrint's GCode viewer","external":"https://foosel.net/assets/content/blog/2021-05-09-a-debugging-story/issue_4117.png"},"content":"\nAbout a week ago I got a new [bug report](https://github.com/OctoPrint/OctoPrint/issues/4117) on [OctoPrint's](https://octoprint.org) issue tracker:\n\n\u003e **GCode Viewer Visualisation Problem**\n\u003e\n\u003e *The problem*\n\u003e \n\u003e The visualisation in GCode viewer ist not correct. The print is OK.\n\u003e See gcode file (zip) on Layer 43 to 47 and 49\n\u003e\n\u003e And screenshot\n\nYou already saw the included screenshot, and it shows that there was a spike being visualized in the GCode Viewer that\nwasn't actually there. My first attempt at reproduction failed spectacularly -- the file looked exactly like\nit was supposed to. Then I noticed that the OP was using Google Chrome however (adding the detected user agent\nto the system information contained in OctoPrint's new System Info Bundles already paid off!) and tried with that\ninstead of my usual Firefox, and lo and behold, I saw the issue.\n\nScrolling a bit through the file revealed further defects, as also mentioned by the OP, e.g. this one:\n\n![Another defect, this time a whole part of the outline is being misplaced](./issue_4117_2.png)\n\nAt this point it was clear that this was a Chrome-only issue. But was it a bug in OctoPrint or possibly a browser \nbug? More information for that was needed but not readily available, and the file was also too big to quickly\ngleam anything from the GCode itself that could possibly help to narrow down on the problem. \n\nSo the first step was to create a minimal GCode file that showed the same error. For this I took a look at \nthe reported layer height in the viewer on the layer a defect was visible and then narrowed down on the affected lines\nby using the horizontal command sliders to further limit the view. That way I quickly found that these were the \nproblematic lines:\n\n``` gcode\nG1 X173.595 Y103.9 E247.16716\nG3 X173.600 Y126.097 I-105613.507 J39.645 E248.20080\nG1 X169.552 Y126.098 E248.38933\n```\n\nMore specifically, the error was caused by the contained [`G3` command](https://reprap.org/wiki/G-code#G2_.26_G3:_Controlled_Arc_Move), \nwhich instructs the printer to move in a counter clockwise arc\nfrom its current position to the given X and Y coordinates, with the center of said arc offset by the given I and J\nparameters. In the case of these lines, that meant to move in an arc from `(173.595, 103.0)` to `(173.600, 126.097)`\nwith the arc's center at `x = 173.595 + (-105613.507) = -105439.912` and `y = 103.9 + 39.645 = 143.54500000000002`. \nOr in other words, a rather short arc with an enormous radius of over 105m that was more a straight line than\nan arc really. And that line was being drawn too long, causing the weird spike in the rendition.\n\nIn order to understand how that could happen however we need to take a look at how the GCode viewer is implemented and how\narcs work in that implementation. At its core, the GCode viewer is an HTML5 2D canvas on which the path described in \na GCode file gets drawn. Commands like `G0` and `G1` that describe straight lines are drawn using [`lineTo`](https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/lineTo),\narcs as described by `G2` and `G3` are drawn using [`arc`](https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/arc).\n\n`arc` takes six parameters: the `x` and `y` coordinate of the center of the arc, the radius `r`, the `startAngle` determining from which angle to start\ndrawing the arc and the `endAngle` until which to draw the arc, and a flag that's `true` for counter clockwise and `false` or empty for clockwise.\nIt is obvious this doesn't directly translate to the data contained in the GCode itself, where we rather have three points defining the arc -- a start\npoint, and end point, and the arc's center. So we need to translate this into the data required by the `arc` method. Using some trigonometry,\nthat is fairly straightforward:\n\n``` js\n// given: G2/G3 X\u003cendX\u003e Y\u003cendY\u003e I\u003ci\u003e J\u003cj\u003e, \u003cstartX\u003e, \u003cstartY\u003e\narcX = startX + i;\narcY = startY + j;\nr = Math.sqrt(i * i + j * j);\nstartAngle = Math.atan2(startY - arcY, startX - arcX);\nendAngle = Math.atan2(endY - arcY, endX - arcX);\nccw = (command === \"G3\")\n```\n\n![The parameters and their relation](./drawing.png)\n\nMy first guess was that the result of this conversion was somehow different between Firefox and Chrome, and so I modified the GCode viewer to log\nthe calculated values and then compared the two outcomes. The values were completely identical between both browsers, so what was being fed\ninto the canvas `arc` command was identical and yet produces different results. Why?\n\nMy next approach was to add some more visual debug output to the viewer itself. I modified it such that the arc parameters as calculated would \nactually be drawn on the canvas as well, in form of a geometrical pizza slice showing the arc's center, its \"legs\" and its rim. And this is where\nI saw a difference in the rendered output. Where in Firefox the arc's rim and its legs met perfectly:\n\n![The arc in Firefox is rendered correctly](./arc_ff.png)\n\nin Chrome the rim overshot:\n\n![The same arc in Chrome is rendered wrong](./arc_chrome.png)\n\nSo while the calculated parameters were correct and in both cases provided to the `arc` method just the same, Chrome was rendering the wrong segment length! \n\nI suspected a rounding error and thus started searching for matching reports from other people. I couldn't find a specific bug report, but I came across a post on Stack Overflow that sounded mightily familiar: [HTML5 canvas arcs not rendering correctly in Google Chrome](https://stackoverflow.com/questions/8603656/html5-canvas-arcs-not-rendering-correctly-in-google-chrome), from 2011. A ten year old post... could it be?\n\nHonestly, I still do not know if this indeed described the same issue or not, or if there's a Chrome ticket describing this behaviour -- I'll continue to look, but first and foremost I was focused on fixing this problem in OctoPrint's GCode viewer. The Stack Overflow post provided a code snippet that reimplements `arc` utilizing bezier curves, and so I gave this a try. Long story short, OctoPrint's GCode Viewer as part of version 1.7.0+ will ship with a Chrome-only `arc` replacement that will be enabled by default, but can also be disabled in real time, with great effect:\n\n![Enabling and disabling the arc workaround makes the defects disappear and reappear](./arc_fix.gif)\n\nAnd the moral of the story: It rarely is a browser bug. But sometimes, all signs say it indeed *is* and a workaround is the easiest solution.\n","assets":[{"slug":"2021-05-09-a-debugging-story","asset":"arc_chrome.png","path":"/home/runner/work/foosel.github.io/foosel.github.io/content/posts/2021-05-09-a-debugging-story/arc_chrome.png"},{"slug":"2021-05-09-a-debugging-story","asset":"arc_ff.png","path":"/home/runner/work/foosel.github.io/foosel.github.io/content/posts/2021-05-09-a-debugging-story/arc_ff.png"},{"slug":"2021-05-09-a-debugging-story","asset":"arc_fix.gif","path":"/home/runner/work/foosel.github.io/foosel.github.io/content/posts/2021-05-09-a-debugging-story/arc_fix.gif"},{"slug":"2021-05-09-a-debugging-story","asset":"drawing.png","path":"/home/runner/work/foosel.github.io/foosel.github.io/content/posts/2021-05-09-a-debugging-story/drawing.png"},{"slug":"2021-05-09-a-debugging-story","asset":"issue_4117.png","path":"/home/runner/work/foosel.github.io/foosel.github.io/content/posts/2021-05-09-a-debugging-story/issue_4117.png"},{"slug":"2021-05-09-a-debugging-story","asset":"issue_4117_2.png","path":"/home/runner/work/foosel.github.io/foosel.github.io/content/posts/2021-05-09-a-debugging-story/issue_4117_2.png"}],"published":"2021-05-09T00:00:00Z","readingtime":{"text":"6 min read","minutes":5.27,"time":316200,"words":1054},"mdx":{"compiledSource":"\"use strict\";\n\nvar _excluded = [\"components\"];\n\nfunction _extends() { _extends = Object.assign || function (target) { for (var i = 1; i \u003c arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i \u003c sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) \u003e= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i \u003c sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) \u003e= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsxRuntime classic */\n\n/* @jsx mdx */\nvar layoutProps = {};\nvar MDXLayout = \"wrapper\";\n\nfunction MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, _excluded);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"p\", null, \"About a week ago I got a new \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://github.com/OctoPrint/OctoPrint/issues/4117\"\n  }, \"bug report\"), \" on \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://octoprint.org\"\n  }, \"OctoPrint's\"), \" issue tracker:\"), mdx(\"blockquote\", null, mdx(\"p\", {\n    parentName: \"blockquote\"\n  }, mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"GCode Viewer Visualisation Problem\")), mdx(\"p\", {\n    parentName: \"blockquote\"\n  }, mdx(\"em\", {\n    parentName: \"p\"\n  }, \"The problem\")), mdx(\"p\", {\n    parentName: \"blockquote\"\n  }, \"The visualisation in GCode viewer ist not correct. The print is OK.\\nSee gcode file (zip) on Layer 43 to 47 and 49\"), mdx(\"p\", {\n    parentName: \"blockquote\"\n  }, \"And screenshot\")), mdx(\"p\", null, \"You already saw the included screenshot, and it shows that there was a spike being visualized in the GCode Viewer that\\nwasn't actually there. My first attempt at reproduction failed spectacularly -- the file looked exactly like\\nit was supposed to. Then I noticed that the OP was using Google Chrome however (adding the detected user agent\\nto the system information contained in OctoPrint's new System Info Bundles already paid off!) and tried with that\\ninstead of my usual Firefox, and lo and behold, I saw the issue.\"), mdx(\"p\", null, \"Scrolling a bit through the file revealed further defects, as also mentioned by the OP, e.g. this one:\"), mdx(\"p\", null, mdx(\"img\", {\n    parentName: \"p\",\n    \"src\": \"./issue_4117_2.png\",\n    \"alt\": \"Another defect, this time a whole part of the outline is being misplaced\"\n  })), mdx(\"p\", null, \"At this point it was clear that this was a Chrome-only issue. But was it a bug in OctoPrint or possibly a browser\\nbug? More information for that was needed but not readily available, and the file was also too big to quickly\\ngleam anything from the GCode itself that could possibly help to narrow down on the problem. \"), mdx(\"p\", null, \"So the first step was to create a minimal GCode file that showed the same error. For this I took a look at\\nthe reported layer height in the viewer on the layer a defect was visible and then narrowed down on the affected lines\\nby using the horizontal command sliders to further limit the view. That way I quickly found that these were the\\nproblematic lines:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-gcode\"\n  }, \"G1 X173.595 Y103.9 E247.16716\\nG3 X173.600 Y126.097 I-105613.507 J39.645 E248.20080\\nG1 X169.552 Y126.098 E248.38933\\n\")), mdx(\"p\", null, \"More specifically, the error was caused by the contained \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://reprap.org/wiki/G-code#G2_.26_G3:_Controlled_Arc_Move\"\n  }, mdx(\"inlineCode\", {\n    parentName: \"a\"\n  }, \"G3\"), \" command\"), \",\\nwhich instructs the printer to move in a counter clockwise arc\\nfrom its current position to the given X and Y coordinates, with the center of said arc offset by the given I and J\\nparameters. In the case of these lines, that meant to move in an arc from \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"(173.595, 103.0)\"), \" to \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"(173.600, 126.097)\"), \"\\nwith the arc's center at \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"x = 173.595 + (-105613.507) = -105439.912\"), \" and \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"y = 103.9 + 39.645 = 143.54500000000002\"), \".\\nOr in other words, a rather short arc with an enormous radius of over 105m that was more a straight line than\\nan arc really. And that line was being drawn too long, causing the weird spike in the rendition.\"), mdx(\"p\", null, \"In order to understand how that could happen however we need to take a look at how the GCode viewer is implemented and how\\narcs work in that implementation. At its core, the GCode viewer is an HTML5 2D canvas on which the path described in\\na GCode file gets drawn. Commands like \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"G0\"), \" and \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"G1\"), \" that describe straight lines are drawn using \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/lineTo\"\n  }, mdx(\"inlineCode\", {\n    parentName: \"a\"\n  }, \"lineTo\")), \",\\narcs as described by \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"G2\"), \" and \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"G3\"), \" are drawn using \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/arc\"\n  }, mdx(\"inlineCode\", {\n    parentName: \"a\"\n  }, \"arc\")), \".\"), mdx(\"p\", null, mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"arc\"), \" takes six parameters: the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"x\"), \" and \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"y\"), \" coordinate of the center of the arc, the radius \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"r\"), \", the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"startAngle\"), \" determining from which angle to start\\ndrawing the arc and the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"endAngle\"), \" until which to draw the arc, and a flag that's \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"true\"), \" for counter clockwise and \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"false\"), \" or empty for clockwise.\\nIt is obvious this doesn't directly translate to the data contained in the GCode itself, where we rather have three points defining the arc -- a start\\npoint, and end point, and the arc's center. So we need to translate this into the data required by the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"arc\"), \" method. Using some trigonometry,\\nthat is fairly straightforward:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-js\"\n  }, \"// given: G2/G3 X\u003cendX\u003e Y\u003cendY\u003e I\u003ci\u003e J\u003cj\u003e, \u003cstartX\u003e, \u003cstartY\u003e\\narcX = startX + i;\\narcY = startY + j;\\nr = Math.sqrt(i * i + j * j);\\nstartAngle = Math.atan2(startY - arcY, startX - arcX);\\nendAngle = Math.atan2(endY - arcY, endX - arcX);\\nccw = (command === \\\"G3\\\")\\n\")), mdx(\"p\", null, mdx(\"img\", {\n    parentName: \"p\",\n    \"src\": \"./drawing.png\",\n    \"alt\": \"The parameters and their relation\"\n  })), mdx(\"p\", null, \"My first guess was that the result of this conversion was somehow different between Firefox and Chrome, and so I modified the GCode viewer to log\\nthe calculated values and then compared the two outcomes. The values were completely identical between both browsers, so what was being fed\\ninto the canvas \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"arc\"), \" command was identical and yet produces different results. Why?\"), mdx(\"p\", null, \"My next approach was to add some more visual debug output to the viewer itself. I modified it such that the arc parameters as calculated would\\nactually be drawn on the canvas as well, in form of a geometrical pizza slice showing the arc's center, its \\\"legs\\\" and its rim. And this is where\\nI saw a difference in the rendered output. Where in Firefox the arc's rim and its legs met perfectly:\"), mdx(\"p\", null, mdx(\"img\", {\n    parentName: \"p\",\n    \"src\": \"./arc_ff.png\",\n    \"alt\": \"The arc in Firefox is rendered correctly\"\n  })), mdx(\"p\", null, \"in Chrome the rim overshot:\"), mdx(\"p\", null, mdx(\"img\", {\n    parentName: \"p\",\n    \"src\": \"./arc_chrome.png\",\n    \"alt\": \"The same arc in Chrome is rendered wrong\"\n  })), mdx(\"p\", null, \"So while the calculated parameters were correct and in both cases provided to the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"arc\"), \" method just the same, Chrome was rendering the wrong segment length! \"), mdx(\"p\", null, \"I suspected a rounding error and thus started searching for matching reports from other people. I couldn't find a specific bug report, but I came across a post on Stack Overflow that sounded mightily familiar: \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://stackoverflow.com/questions/8603656/html5-canvas-arcs-not-rendering-correctly-in-google-chrome\"\n  }, \"HTML5 canvas arcs not rendering correctly in Google Chrome\"), \", from 2011. A ten year old post... could it be?\"), mdx(\"p\", null, \"Honestly, I still do not know if this indeed described the same issue or not, or if there's a Chrome ticket describing this behaviour -- I'll continue to look, but first and foremost I was focused on fixing this problem in OctoPrint's GCode viewer. The Stack Overflow post provided a code snippet that reimplements \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"arc\"), \" utilizing bezier curves, and so I gave this a try. Long story short, OctoPrint's GCode Viewer as part of version 1.7.0+ will ship with a Chrome-only \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"arc\"), \" replacement that will be enabled by default, but can also be disabled in real time, with great effect:\"), mdx(\"p\", null, mdx(\"img\", {\n    parentName: \"p\",\n    \"src\": \"./arc_fix.gif\",\n    \"alt\": \"Enabling and disabling the arc workaround makes the defects disappear and reappear\"\n  })), mdx(\"p\", null, \"And the moral of the story: It rarely is a browser bug. But sometimes, all signs say it indeed \", mdx(\"em\", {\n    parentName: \"p\"\n  }, \"is\"), \" and a workaround is the easiest solution.\"));\n}\n\n;\nMDXContent.isMDXComponent = true;","renderedOutput":"\u003cp\u003eAbout a week ago I got a new \u003ca pathname=\"/blog/2021-05-09-a-debugging-story\" href=\"https://github.com/OctoPrint/OctoPrint/issues/4117\"\u003ebug report\u003c/a\u003e on \u003ca pathname=\"/blog/2021-05-09-a-debugging-story\" href=\"https://octoprint.org\"\u003eOctoPrint\u0026#x27;s\u003c/a\u003e issue tracker:\u003c/p\u003e\u003cblockquote\u003e\u003cp\u003e\u003cstrong\u003eGCode Viewer Visualisation Problem\u003c/strong\u003e\u003c/p\u003e\u003cp\u003e\u003cem\u003eThe problem\u003c/em\u003e\u003c/p\u003e\u003cp\u003eThe visualisation in GCode viewer ist not correct. The print is OK.\nSee gcode file (zip) on Layer 43 to 47 and 49\u003c/p\u003e\u003cp\u003eAnd screenshot\u003c/p\u003e\u003c/blockquote\u003e\u003cp\u003eYou already saw the included screenshot, and it shows that there was a spike being visualized in the GCode Viewer that\nwasn\u0026#x27;t actually there. My first attempt at reproduction failed spectacularly -- the file looked exactly like\nit was supposed to. Then I noticed that the OP was using Google Chrome however (adding the detected user agent\nto the system information contained in OctoPrint\u0026#x27;s new System Info Bundles already paid off!) and tried with that\ninstead of my usual Firefox, and lo and behold, I saw the issue.\u003c/p\u003e\u003cp\u003eScrolling a bit through the file revealed further defects, as also mentioned by the OP, e.g. this one:\u003c/p\u003e\u003cp\u003e\u003cimg pathname=\"/blog/2021-05-09-a-debugging-story\" src=\"/assets/content/blog/2021-05-09-a-debugging-story/issue_4117_2.png\" alt=\"Another defect, this time a whole part of the outline is being misplaced\"/\u003e\u003c/p\u003e\u003cp\u003eAt this point it was clear that this was a Chrome-only issue. But was it a bug in OctoPrint or possibly a browser\nbug? More information for that was needed but not readily available, and the file was also too big to quickly\ngleam anything from the GCode itself that could possibly help to narrow down on the problem. \u003c/p\u003e\u003cp\u003eSo the first step was to create a minimal GCode file that showed the same error. For this I took a look at\nthe reported layer height in the viewer on the layer a defect was visible and then narrowed down on the affected lines\nby using the horizontal command sliders to further limit the view. That way I quickly found that these were the\nproblematic lines:\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"language-gcode\"\u003eG1 X173.595 Y103.9 E247.16716\nG3 X173.600 Y126.097 I-105613.507 J39.645 E248.20080\nG1 X169.552 Y126.098 E248.38933\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eMore specifically, the error was caused by the contained \u003ca pathname=\"/blog/2021-05-09-a-debugging-story\" href=\"https://reprap.org/wiki/G-code#G2_.26_G3:_Controlled_Arc_Move\"\u003e\u003ccode\u003eG3\u003c/code\u003e command\u003c/a\u003e,\nwhich instructs the printer to move in a counter clockwise arc\nfrom its current position to the given X and Y coordinates, with the center of said arc offset by the given I and J\nparameters. In the case of these lines, that meant to move in an arc from \u003ccode\u003e(173.595, 103.0)\u003c/code\u003e to \u003ccode\u003e(173.600, 126.097)\u003c/code\u003e\nwith the arc\u0026#x27;s center at \u003ccode\u003ex = 173.595 + (-105613.507) = -105439.912\u003c/code\u003e and \u003ccode\u003ey = 103.9 + 39.645 = 143.54500000000002\u003c/code\u003e.\nOr in other words, a rather short arc with an enormous radius of over 105m that was more a straight line than\nan arc really. And that line was being drawn too long, causing the weird spike in the rendition.\u003c/p\u003e\u003cp\u003eIn order to understand how that could happen however we need to take a look at how the GCode viewer is implemented and how\narcs work in that implementation. At its core, the GCode viewer is an HTML5 2D canvas on which the path described in\na GCode file gets drawn. Commands like \u003ccode\u003eG0\u003c/code\u003e and \u003ccode\u003eG1\u003c/code\u003e that describe straight lines are drawn using \u003ca pathname=\"/blog/2021-05-09-a-debugging-story\" href=\"https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/lineTo\"\u003e\u003ccode\u003elineTo\u003c/code\u003e\u003c/a\u003e,\narcs as described by \u003ccode\u003eG2\u003c/code\u003e and \u003ccode\u003eG3\u003c/code\u003e are drawn using \u003ca pathname=\"/blog/2021-05-09-a-debugging-story\" href=\"https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/arc\"\u003e\u003ccode\u003earc\u003c/code\u003e\u003c/a\u003e.\u003c/p\u003e\u003cp\u003e\u003ccode\u003earc\u003c/code\u003e takes six parameters: the \u003ccode\u003ex\u003c/code\u003e and \u003ccode\u003ey\u003c/code\u003e coordinate of the center of the arc, the radius \u003ccode\u003er\u003c/code\u003e, the \u003ccode\u003estartAngle\u003c/code\u003e determining from which angle to start\ndrawing the arc and the \u003ccode\u003eendAngle\u003c/code\u003e until which to draw the arc, and a flag that\u0026#x27;s \u003ccode\u003etrue\u003c/code\u003e for counter clockwise and \u003ccode\u003efalse\u003c/code\u003e or empty for clockwise.\nIt is obvious this doesn\u0026#x27;t directly translate to the data contained in the GCode itself, where we rather have three points defining the arc -- a start\npoint, and end point, and the arc\u0026#x27;s center. So we need to translate this into the data required by the \u003ccode\u003earc\u003c/code\u003e method. Using some trigonometry,\nthat is fairly straightforward:\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"language-js\"\u003e// given: G2/G3 X\u0026lt;endX\u0026gt; Y\u0026lt;endY\u0026gt; I\u0026lt;i\u0026gt; J\u0026lt;j\u0026gt;, \u0026lt;startX\u0026gt;, \u0026lt;startY\u0026gt;\narcX = startX + i;\narcY = startY + j;\nr = Math.sqrt(i * i + j * j);\nstartAngle = Math.atan2(startY - arcY, startX - arcX);\nendAngle = Math.atan2(endY - arcY, endX - arcX);\nccw = (command === \u0026quot;G3\u0026quot;)\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cimg pathname=\"/blog/2021-05-09-a-debugging-story\" src=\"/assets/content/blog/2021-05-09-a-debugging-story/drawing.png\" alt=\"The parameters and their relation\"/\u003e\u003c/p\u003e\u003cp\u003eMy first guess was that the result of this conversion was somehow different between Firefox and Chrome, and so I modified the GCode viewer to log\nthe calculated values and then compared the two outcomes. The values were completely identical between both browsers, so what was being fed\ninto the canvas \u003ccode\u003earc\u003c/code\u003e command was identical and yet produces different results. Why?\u003c/p\u003e\u003cp\u003eMy next approach was to add some more visual debug output to the viewer itself. I modified it such that the arc parameters as calculated would\nactually be drawn on the canvas as well, in form of a geometrical pizza slice showing the arc\u0026#x27;s center, its \u0026quot;legs\u0026quot; and its rim. And this is where\nI saw a difference in the rendered output. Where in Firefox the arc\u0026#x27;s rim and its legs met perfectly:\u003c/p\u003e\u003cp\u003e\u003cimg pathname=\"/blog/2021-05-09-a-debugging-story\" src=\"/assets/content/blog/2021-05-09-a-debugging-story/arc_ff.png\" alt=\"The arc in Firefox is rendered correctly\"/\u003e\u003c/p\u003e\u003cp\u003ein Chrome the rim overshot:\u003c/p\u003e\u003cp\u003e\u003cimg pathname=\"/blog/2021-05-09-a-debugging-story\" src=\"/assets/content/blog/2021-05-09-a-debugging-story/arc_chrome.png\" alt=\"The same arc in Chrome is rendered wrong\"/\u003e\u003c/p\u003e\u003cp\u003eSo while the calculated parameters were correct and in both cases provided to the \u003ccode\u003earc\u003c/code\u003e method just the same, Chrome was rendering the wrong segment length! \u003c/p\u003e\u003cp\u003eI suspected a rounding error and thus started searching for matching reports from other people. I couldn\u0026#x27;t find a specific bug report, but I came across a post on Stack Overflow that sounded mightily familiar: \u003ca pathname=\"/blog/2021-05-09-a-debugging-story\" href=\"https://stackoverflow.com/questions/8603656/html5-canvas-arcs-not-rendering-correctly-in-google-chrome\"\u003eHTML5 canvas arcs not rendering correctly in Google Chrome\u003c/a\u003e, from 2011. A ten year old post... could it be?\u003c/p\u003e\u003cp\u003eHonestly, I still do not know if this indeed described the same issue or not, or if there\u0026#x27;s a Chrome ticket describing this behaviour -- I\u0026#x27;ll continue to look, but first and foremost I was focused on fixing this problem in OctoPrint\u0026#x27;s GCode viewer. The Stack Overflow post provided a code snippet that reimplements \u003ccode\u003earc\u003c/code\u003e utilizing bezier curves, and so I gave this a try. Long story short, OctoPrint\u0026#x27;s GCode Viewer as part of version 1.7.0+ will ship with a Chrome-only \u003ccode\u003earc\u003c/code\u003e replacement that will be enabled by default, but can also be disabled in real time, with great effect:\u003c/p\u003e\u003cp\u003e\u003cimg pathname=\"/blog/2021-05-09-a-debugging-story\" src=\"/assets/content/blog/2021-05-09-a-debugging-story/arc_fix.gif\" alt=\"Enabling and disabling the arc workaround makes the defects disappear and reappear\"/\u003e\u003c/p\u003e\u003cp\u003eAnd the moral of the story: It rarely is a browser bug. But sometimes, all signs say it indeed \u003cem\u003eis\u003c/em\u003e and a workaround is the easiest solution.\u003c/p\u003e","scope":{}}},"seo":{"title":"A debugging story","description":"Could this bug for once not be my fault?","openGraph":{"title":"A debugging story","url":"https://foosel.net/blog/2021-05-09-a-debugging-story","description":"Could this bug for once not be my fault?","images":[{"url":"https://foosel.net/assets/content/blog/2021-05-09-a-debugging-story/issue_4117.png","alt":"The screenshot showing the issue -- a rendering defect in OctoPrint's GCode viewer","external":"https://foosel.net/assets/content/blog/2021-05-09-a-debugging-story/issue_4117.png"}],"type":"article","article":{"publishedTime":"2021-05-09T00:00:00Z","modifiedTime":"2021-05-09T00:00:00Z"}}},"previous":{"link":"/blog/2021-03-28-homelab-uplink-monitoring","title":"Homelab uplink monitoring"},"next":{"link":"/blog/2021-09-12-hydroponics-the-kratky-way","title":"Hydroponics the Kratky way"}},"__N_SSG":true},"page":"/blog/[slug]","query":{"slug":"2021-05-09-a-debugging-story"},"buildId":"TZJjmG4P0nL75dt6pazby","runtimeConfig":{},"isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>